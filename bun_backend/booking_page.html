<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dream Barber - Broneeri aeg juuksurile</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Roboto', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 500px; width: 100%; }
    h1 { font-family: 'Pacifico', cursive; color: #667eea; text-align: center; font-size: 48px; margin-bottom: 10px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 16px; }
    .hairdressers { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; }
    .hairdresser-btn { padding: 12px; border: 2px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
    .hairdresser-btn:hover { border-color: #667eea; color: #667eea; }
    .hairdresser-btn.selected { background: #667eea; color: white; border-color: #667eea; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .time-slots { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 25px; }
    .time-btn { padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
    .time-btn:hover { border-color: #667eea; }
    .time-btn.selected { background: #667eea; color: white; border-color: #667eea; }
    .time-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    button.submit { width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    button.submit:hover { background: #764ba2; }
    .error { color: #e74c3c; padding: 12px; background: #fadbd8; border-radius: 4px; margin-bottom: 20px; border: 1px solid #f5b7b1; }
    .success { color: #27ae60; padding: 12px; background: #d5f4e6; border-radius: 4px; margin-bottom: 20px; border: 1px solid #a9dfbf; }
    .loading { display: none; text-align: center; color: #667eea; }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #ddd; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dream Barber</h1>
    <p class="subtitle">Broneeri aeg juuksurile</p>

    <div id="message"></div>

    <form id="bookingForm">
      <div class="form-group">
        <label>Juuksur *</label>
        <div class="hairdressers" id="hairdressers"></div>
      </div>

      <div class="form-group">
        <label>Kuupäev *</label>
        <input type="date" id="date" required>
      </div>

      <div class="form-group">
        <label>Aeg *</label>
        <div class="time-slots" id="timeSlots"></div>
      </div>

      <div class="form-group">
        <label>Nimi *</label>
        <input type="text" id="clientName" required>
      </div>

      <div class="form-group">
        <label>Telefon *</label>
        <input type="tel" id="clientPhone" required>
      </div>

      <div class="form-group">
        <label>Email *</label>
        <input type="email" id="clientEmail" required>
      </div>

      <div class="form-group">
        <label>Lisainfo</label>
        <input type="text" id="extraInfo">
      </div>

      <button type="submit" class="submit">
        <span class="spinner" id="spinner" style="display: none;"></span>
        BRONEERI AELG
      </button>
    </form>
  </div>

  <script>
    const API = 'http://localhost:3001/api';
    let selectedHairdresser = null;
    let selectedTime = null;

    async function init() {
      try {
        const res = await fetch(`${API}/bookings/hairdressers`);
        const hairdressers = await res.json();
        const container = document.getElementById('hairdressers');
        hairdressers.forEach(h => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = h.name;
          btn.className = 'hairdresser-btn';
          btn.onclick = (e) => {
            e.preventDefault();
            document.querySelectorAll('.hairdresser-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedHairdresser = h.id;
            loadTimes();
          };
          container.appendChild(btn);
        });

        const dateInput = document.getElementById('date');
        const Today = new Date();
        dateInput.min = Today.toISOString().split('T')[0];
        dateInput.addEventListener('change', loadTimes);
      } catch (e) {
        showMessage('Viga: ' + e.message, 'error');
      }
    }

    async function loadTimes() {
      const date = document.getElementById('date').value;
      if (!selectedHairdresser || !date) {
        document.getElementById('timeSlots').innerHTML = '';
        return;
      }

      try {
        const res = await fetch(`${API}/bookings/available?hairdresser_id=${selectedHairdresser}&date=${date}`);
        const times = await res.json();
        const container = document.getElementById('timeSlots');
        container.innerHTML = '';
        times.forEach(time => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = time;
          btn.className = 'time-btn';
          btn.onclick = (e) => {
            e.preventDefault();
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedTime = time;
          };
          container.appendChild(btn);
        });
      } catch (e) {
        showMessage('Viga: ' + e.message, 'error');
      }
    }

    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!selectedHairdresser || !selectedTime) {
        showMessage('Vali juuksur ja aeg', 'error');
        return;
      }

      const spinner = document.getElementById('spinner');
      spinner.style.display = 'inline-block';

      try {
        const res = await fetch(`${API}/bookings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            hairdresser_id: selectedHairdresser,
            client_name: document.getElementById('clientName').value,
            client_phone: document.getElementById('clientPhone').value,
            client_email: document.getElementById('clientEmail').value,
            extra_info: document.getElementById('extraInfo').value,
            date: document.getElementById('date').value,
            time: selectedTime
          })
        });

        if (res.ok) {
          showMessage('Broneering on edukalt loodud! ✓', 'success');
          document.getElementById('bookingForm').reset();
          selectedHairdresser = null;
          selectedTime = null;
          document.querySelectorAll('.hairdresser-btn, .time-btn').forEach(b => b.classList.remove('selected'));
          document.getElementById('timeSlots').innerHTML = '';
        } else {
          const error = await res.json();
          showMessage('Viga: ' + (error.error || 'Tundmatu viga'), 'error');
        }
      } catch (e) {
        showMessage('Viga: ' + e.message, 'error');
      } finally {
        spinner.style.display = 'none';
      }
    });

    function showMessage(msg, type) {
      const div = document.getElementById('message');
      div.innerHTML = `<div class="${type}">${msg}</div>`;
      if (type === 'success') setTimeout(() => { div.innerHTML = ''; }, 5000);
    }

    init();
  </script>
</body>
</html>
